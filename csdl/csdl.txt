-- 0) Danh mục chung
CREATE TABLE companies (
  company_id SERIAL PRIMARY KEY,
  ticker TEXT NOT NULL,
  company_name TEXT NOT NULL,
  industry TEXT,
  UNIQUE(ticker)
);

CREATE TYPE report_type AS ENUM ('quarter', 'semi_annual', 'annual');
CREATE TYPE consolidation AS ENUM ('consolidated','separate');
CREATE TYPE gaap AS ENUM ('VAS','IFRS');
CREATE TYPE audit_opinion AS ENUM ('audit_unqualified','audit_qualified','review','unaudited','other');

CREATE TABLE reports (
  report_id SERIAL PRIMARY KEY,
  company_id INT REFERENCES companies(company_id),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  fiscal_year INT GENERATED ALWAYS AS (EXTRACT(YEAR FROM period_end)) STORED,
  report_type report_type NOT NULL,
  consolidation consolidation NOT NULL,
  gaap gaap NOT NULL,
  currency TEXT NOT NULL DEFAULT 'VND',
  auditor TEXT,
  audit_opinion audit_opinion,
  source_file TEXT,      -- đường dẫn file PDF
  source_note TEXT,      -- link IR, số công văn…
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(company_id, period_start, period_end, consolidation, gaap)
);

-- 1) Taxonomy chỉ tiêu chuẩn hoá cho BS/IS/CF
CREATE TYPE statement_type AS ENUM ('BS','IS','CF','Equity');
CREATE TABLE line_items (
  line_item_id SERIAL PRIMARY KEY,
  statement statement_type NOT NULL,
  std_code TEXT NOT NULL,           -- mã chuẩn hoá: e.g. BS_CASH, IS_REVENUE
  std_label TEXT NOT NULL,          -- nhãn chuẩn hoá tiếng Anh/VN
  native_examples TEXT[],           -- tên gọi thường gặp trong VAS (VD: "Tiền và tương đương tiền")
  vas_code TEXT,                    -- nếu có mapping Mã chỉ tiêu (B01/B02)
  sign INT NOT NULL DEFAULT 1,      -- +1/-1 chuẩn hướng dấu
  UNIQUE(statement, std_code)
);

-- 2) Fact số liệu (mức "chỉ tiêu" trên từng báo cáo)
CREATE TYPE value_context AS ENUM ('current_period','prior_period','beginning','yoy','ttm');
CREATE TABLE facts (
  fact_id BIGSERIAL PRIMARY KEY,
  report_id INT REFERENCES reports(report_id) ON DELETE CASCADE,
  line_item_id INT REFERENCES line_items(line_item_id),
  context value_context NOT NULL,  -- ví dụ "current_period" (số cuối kỳ), "prior_period"
  amount NUMERIC(20,2),
  unit TEXT DEFAULT 'VND',
  dims JSONB DEFAULT '{}'::jsonb,  -- mở rộng: {segment_id:..., currency:..., restated:true}
  page INT,                         -- số trang trong PDF nơi tìm thấy
  src_label TEXT,                   -- nhãn gốc đọc được
  confidence REAL,                  -- độ tin cậy model
  UNIQUE(report_id, line_item_id, context, dims)
);
CREATE INDEX facts_gin_dims ON facts USING GIN (dims);

-- =========================================================
-- Unified Notes table: lưu mọi thuyết minh ở dạng “facts”
-- =========================================================
CREATE TABLE IF NOT EXISTS notes_unified (
  note_id      BIGSERIAL PRIMARY KEY,
  report_id    BIGINT NOT NULL REFERENCES reports(report_id) ON DELETE CASCADE,

  -- Nhóm thuyết minh (vd: borrowings, inventories, receivables, ppe_rollforward, investments, income_taxes, equity_changes, per_share_data, related_parties, cashflows, misc)
  note_group   TEXT NOT NULL,

  -- Khóa con của nhóm (vd: tên ngân hàng/trái phiếu, tên loại hàng tồn kho, lớp TSCĐ, tên khoản mục,…)
  item_key     TEXT,            -- key “máy đọc”
  item_label   TEXT,            -- label “nguyên văn”/dễ đọc

  -- Bối cảnh/cột (vd: closing, opening, movement, q2_2025, ytd_2025, asof_2025, …)
  context_key  TEXT,

  -- Giá trị số + đơn vị
  amount       NUMERIC,
  unit         TEXT DEFAULT 'VND',

  -- Thuộc tính linh hoạt: JSONB (vd: short_long, debt_type, counterparty, interest_rate, ownership_pct, aging_bucket, asset_class,…)
  dims         JSONB,

  -- Trace
  page         INT,
  src_label    TEXT,
  confidence   REAL DEFAULT 0.80,

  -- Fingerprint để idempotent upsert
  fp           TEXT,

  created_at   TIMESTAMPTZ DEFAULT now()
);

-- Tối ưu truy vấn
CREATE INDEX IF NOT EXISTS idx_notes_unified_report ON notes_unified(report_id, note_group);
CREATE INDEX IF NOT EXISTS idx_notes_unified_dims_gin ON notes_unified USING GIN (dims);
CREATE UNIQUE INDEX IF NOT EXISTS uq_notes_unified_fingerprint ON notes_unified(report_id, fp);
